<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
    <title>Add a new table into the Survey service</title>
    <link rel="stylesheet" type="text/css" href="./res/styles/normalize.css">
    <link rel="stylesheet" type="text/css" href="./res/styles/prettify.css" />
    <link rel="stylesheet" type="text/css" href="./res/styles/styles.css">
</head>

<body>
    <!-- Use the same title as the StartHere -->
    <header>Building an Azure Mobile App</header>

    <section id="main">

        <h1 id="page-title"></h1>

        <h2>Duration</h2>
        <p>15 minutes</p>

        <h2>Goals</h2>
        <p>
            In this lab exercise, you will add a new table and enpoint to your mobile application using Visual Studio and ASP.NET. This exercise can only be done if you used <b>ASP.NET</b> to create your back end. If you used the portal to create your service (e.g. <b>Node.js</b>) then you need to use <a href="./part3a.html">these instructions instead</a>.
        </p>

        <h2>Assets</h2>
        <p>
        There is a completed version of the exercise in the <b>Exercise 3/Completed</b> folder.
        </p>  

        <h2>Challenge</h2>
        <p>
            You are going to add a new <b>responses</b> table endpoint. This will require that you create a class to represent this both in our database and over the wire when talking to a client. You will add a class named <code>SurveyResponse</code> to provide this support. You will also need to add a new <code>TableController</code> to expose this table over the network. The DTO you will create will have the following properties:
            <ul>
                <li><code class="prettyprint">string QuestionId</code> to hold the question the person responded to.</li>
                <li><code class="prettyprint">string Name</code> to hold the person's name.</li>
                <li><code class="prettyprint">int AnswerIndex</code> to hold the answer the person selected.</li>
            </ul>
        </p>
        <p>
            You want to store this object in a table named "responses" and have the JSON format for the DTO to be:
            <div class="indent-medium">
<pre class="prettyprint">
{
   questionId: "",
   name: "",
   answer: 0
}
</pre></div>
        </p>
        <p>
            The table controller should expose all the HTTP verbs (<code>GET</code>, <code>POST</code>, <code>PATCH</code>, and <code>DELETE</code>). The default code generated by the <b>Add Controller</b> wizard will generate the proper code for you.
        </p>

        <div class="hintblock">
            The starter project you created already has a table and DTO defined to manage <em>ToDo</em> items as well as a simple API endpoint which returns a string. You can leave all this in place, or go through and delete references to it by deleting all the files in the <b>Controllers</b> folder, <b>DataModels</b> folder and <b>Api</b> folder. These files won't hurt anything - but in a production system you would definitely want to remove these sample files. If you decide to remove them, you will also need to remove the code in the <code>MobileServiceInitializer.Seed</code> method in the <b>Startup.MobileApp.cs</b> file in the <b>App_Start</b> folder.
        </div>

        <!-- Steps -->
        <h1>Steps</h1>

        <h2>Add the response DTO</h2>
        <ol>
            <li>Create a new class in the <b>DataObjects</b> folder. Name it "SurveyResponse".</li>
            <li>Have the class derive from <code>Microsoft.Azure.Mobile.Server.EntityData</code>.
            <li>Add the following public properties to the class:
                <ul class="indent-none">
                    <li><code class="prettyprint">string QuestionId</code> to hold the question the person responded to.</li>
                    <li><code class="prettyprint">string Name</code> to hold the person's name.</li>
                    <li><code class="prettyprint">int AnswerIndex</code> to hold the answer the person selected.</li>
                </ul>
            </li>
        </ol>
<p><a href="#" onclick="toggleCode(this,'dto_object');return false;" class="uiitem">Show Code</a>
<div class="indent-medium" id="dto_object" style="display:none;">
<pre class="prettyprint">
using Microsoft.Azure.Mobile.Server;
...
public class SurveyResponse : EntityData
{
    public string QuestionId { get; set; }
    public string Name { get; set; }
    public int AnswerIndex { get; set; }
}
</pre></div></p>

        <h2>Customize the table and wire format</h2>
        <p>
        You can use attributes to control how our DTO is mapped to the database table through Entity Framework, and how the object will be represented over the wire. Our goal here is to ensure that the JSON structure looks like the above definition and that we use a table named "responses".
        </p>
        <ol>
            <li>Add a <code class="prettyprint">[Table("responses")]</code> attribute to your class definition - this will make the name of the table "responses" instead of "SurveyResponse" which would be the default. This attribute is in the <code>System.ComponentModel.DataAnnotations.Schema</code> namespace.</li>
            <li>Add <code class="prettyprint">[JsonProperty]</code> attributes to the <b>QuestionId</b> and <b>AnswerIndex</b> properties to change their JSON name to be "questionId" and "answer". This attribute is in the <code>Newtonsoft.Json</code>.</li>
        </ol>

<p><a href="#" onclick="toggleCode(this,'dto_object2');return false;" class="uiitem">Show Code</a>
<div class="indent-medium" id="dto_object2" style="display:none;">
<pre class="prettyprint">
using Newtonsoft.Json;
using System.ComponentModel.DataAnnotations.Schema;
...
<mark>[Table("responses")]</mark>
public class SurveyResponse : EntityData
{
    <mark>[JsonProperty("questionId")]</mark>
    public string QuestionId { get; set; }

    public string Name { get; set; }
    <mark>[JsonProperty("answer")]</mark>
    public int AnswerIndex { get; set; }
}
</pre></div></p>   

        <h2>Create the survey response Table Controller</h2>
        <p>
        The next step is to expose this DTO through a Table Controller. You can examine the <b>TodoItemController</b> in the <b>Controllers</b> folder which was added by the project template to see the structure, or even modify this one by changing the DTO it exposes, but the easiest way to add a new controller is through a Visual Studio wizard.
        </p>
        <ol>
            <li>Right-click on the <b>Controllers</b> folder and select <b>Add > Controller</b>.</li>
            <img class="indent-none" src="./res/images/ex3-add-controller.png" />
            <li>Select the <b>Azure Mobile App Table Controller</b> from the wizard.</li>
            <img class="indent-none" src="./res/images/ex3-new-table-controller.png" />
            <li>In the <b>Add Controller</b> dialog:
                <ul class="indent-none">
                    <li>Select your <code>SurveyResponse</code> DTO from the Model class dropdown.</li>
                    <li>Select the <code>MobileServiceContext</code> from the Data context class dropdown.</li>
                    <li>Make the name of your new controller "ResponsesController". This will set the endpoint to "responses".</li>
                </ul>
            </li>
            <img class="indet-none" src="./res/images/ex3-create-controller.png" />
            <li>Click <b>Add</b> to add the controller code. This will add a new class into the <b>Controllers</b> folder and also add a new <code>DbSet&lt;SurveyResponse></code> property into the <code>MobileServiceContext</code> class contained in the <b>Models</b> folder.</li>
            <li>VS should have opened the new <b>ResponsesController.cs</b> in the <b>Controller</b> folder; if not, go ahead and do that and examine it's contents.
                <ul class="indent-none">
                    <li>This is an ASP.NET MVC controller which has a method for each HTTP operation. The prefix on each method name identifies the HTTP verb it responds to.</li>
                    <li>The <code>Initialize</code> method sets up a Entity Framework <code>DbContext</code> which is used to access the database and read/write your DTO from it's associated table.</li>
                </ul>
            </li>
            <li>Since this is an ASP.NET MVC controller, we can use attributes to customize it with ASP.NET attributes. For example, we can rename the methods to match what they do:
                <ul class="indent-none">
                    <li>Rename the <code>PostSurveyResponse</code> method to <code>InsertSurveyResponse</code>. Since we no longer have the word "Post" on the method, the controller won't associate this to an HTTP POST request. To correct this, add a <code class="prettyprint">[HttpPost]</code> attribute onto the method.</li>
                    <li>Rename the <code>PatchSurveyResponse</code> method to <code>UpdateSurveyResponse</code> and add a <code class="prettyprint">[HttpPatch]</code> attribute onto the method to ensure it responds to an HTTP PATCH request.</li>
                </ul>
            </li>            
        </ol>

<p><a href="#" onclick="toggleCode(this,'tablecontroller');return false;" class="uiitem">Show Code</a>
<div class="indent-medium" id="tablecontroller" style="display:none;">
<pre class="prettyprint">
public class ResponsesController : TableController&lt;SurveyResponse>
{
    ...
    // PATCH tables/Responses/48D68C86-6EA6-4C25-AA33-223FC9A27959
    <mark>[HttpPatch]</mark>
    public Task&lt;SurveyResponse> <mark>Update</mark>SurveyResponse(string id, Delta&lt;SurveyResponse> patch)
    {
            return UpdateAsync(id, patch);
    }

    // POST tables/Responses
    <mark>[HttpPost]</mark>
    public async Task&lt;IHttpActionResult> <mark>Insert</mark>SurveyResponse(SurveyResponse item)
    {
        SurveyResponse current = await InsertAsync(item);
        return CreatedAtRoute("Tables", new { id = current.Id }, current);
    }
    ...
}
</pre></div></p> 

        <h2>Publish the site</h2>
        <p>
        Publish the site to Azure (or run it locally).
        </p>        

        <h2>Check your table endpoint (Optional)</h2>
        <p>
        Now that we've setup our table, let's make sure the endpoint is working. You can use any generic REST client you prefer, a nice, free one is <a href="https://www.getpostman.com/">Postman</a> which is available as a plug-in for Chrome. You can even hit the endpoint with a regular browser, but since it will be missing the header value, you will get an error back (indicating you are missing the header value).
        </p>
        <ol>
            <li>Open your REST client.</li>
            <li>The table endpoint will be the URL for your service followed by <b>/tables/responses</b>. So, for example if your site name is <b>castthevote</b>, then the full URL for the table would be: <b>http://castthevote.azurewebsites.net/tables/responses</b>.</li>
            <li>Add a header value with the name <b>ZUMO-API-VERSION</b> and set it's value to "2.0.0".</li>
            <li>Issue a <b>GET</b> request.</li>
            <li>Since the table has no data in it, you should get back an empty JSON array: <code>[]</code>.</li>
            <li>Alternatively, if you are using a Linux/Mac system, or have access to the command-line Curl, you can use it to hit the service and see the response:
<pre class="codeblock">
$ curl -H ZUMO-API-VERSION:2.0.0 -g http://castthevote.azurewebsites.net/tables/responses
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100     2  100     2    0     0     32      0 --:--:-- --:--:-- --:--:--    42[]
</pre>
        </ol>


        <h1>Summary</h1>
        <p>
            In this exercise, you added a new DTO and table controller to your service using Visual Studio.
        </p>
        <div class="align-right">
            <a href="../Start%20Here.html">Go Back</a>
        </div>
    </section>

    <script src="./res/js/jquery.min.js"></script>
    <script src="./res/js/prettify.js"></script>
    <script src="./res/js/script.js"></script>

    <footer>Copyright (C) 2018 Xamarin Inc., Microsoft.</footer>
</body>
</html>
